<!DOCTYPE html>
<html>
<head>
	<title>Fruit head</title>
	<style type="text/css">
		html, body {
			height: 100%;
		}
		body {
			margin: 0;
		}
		video {
			width: 320px;
			height: 240px;
		}
		canvas {
			width: 450px;
			height: 450px;
			position: absolute;
			margin: auto;
			top: -40px;
			left: 0;
			bottom: 0;
			right: 0;
		}
		.background {
			position: absolute;
			margin: auto;
			width: 620px;
			height: 560px;
			top: -120px;
			left: -40px;
			bottom: 0;
			right: 0;
		}
	</style>
</head>
<body>
	<video width="640" height="480" autoplay></video>
	<img src="apple.jpg" class="background">
	<canvas width="640" height="480"></canvas>
	<script src="../../bower_components/clmtrackr/clmtrackr.js"></script>
	<script src="../../bower_components/clmtrackr/models/model_pca_20_svm.js"></script>
	<script>
	(function() {
		'use strict';

		var MOUTH_INSIDE_VERTICES_INDICES = [
			[44, 61, 56],
			[61, 60, 56],
			[56, 60, 57],
			[60, 59, 57],
			[57, 59, 58],
			[58, 59, 50]
		];

		var ENLARGE = 20;

		var MOUTH_INDICES = [44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61];

		var App = function() {
			this.ctracker = new clm.tracker();
			this.ctracker.init(pModel);
			this.canvas = document.getElementsByTagName('canvas')[0];
			this.mask = new Image();
			this.mask.src = 'mask.png';
			this.ctx = this.canvas.getContext('2d');
			this.mouthRect = {x:0, y:0, width:0, height:0};
			this.leftEyeRect = {x:0, y:0, width:0, height:0};
			this.rightEyeRect = {x:0, y:0, width:0, height:0};
			navigator.getUserMedia({video: true}, this.onVideoSuccess.bind(this), function(){});
		};

		App.prototype.onVideoSuccess = function(localMediaStream) {
			this.video = document.getElementsByTagName('video')[0];
			this.video.src = window.URL.createObjectURL(localMediaStream);
			this.ctracker.start(this.video);
			this.update();
		};

		App.prototype.update = function() {
			requestAnimationFrame(this.update.bind(this));
			this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
			var positions = this.ctracker.getCurrentPosition();
			// var mouthCenter = {
			// 	x:(positions[60][0] + positions[57][0]) * 0.5,
			// 	y:(positions[60][1] + positions[57][1]) * 0.5
			// };

			this.mouthRect.x = positions[44][0];
			this.mouthRect.y = positions[46][1];
			this.mouthRect.width = positions[50][0] - this.mouthRect.x;
			this.mouthRect.height = positions[53][1] - this.mouthRect.y;

			this.leftEyeRect.x = positions[23][0];
			this.leftEyeRect.y = positions[24][1];
			this.leftEyeRect.width = positions[25][0] - this.leftEyeRect.x;
			this.leftEyeRect.height = positions[26][1] - this.leftEyeRect.y;

			this.rightEyeRect.x = positions[30][0];
			this.rightEyeRect.y = positions[29][1];
			this.rightEyeRect.width = positions[28][0] - this.rightEyeRect.x;
			this.rightEyeRect.height = positions[31][1] - this.rightEyeRect.y;

			// console.log(this.mouthRect.x, this.mouthRect.y, this.mouthRect.width, this.mouthRect.height);


			// this.ctx.drawImage(this.video, 0, 0, 640, 480);
			this.ctx.drawImage(this.video, this.mouthRect.x - ENLARGE, this.mouthRect.y - ENLARGE, this.mouthRect.width + ENLARGE * 2, this.mouthRect.height + ENLARGE * 2, 0, 240, 640, 240);
			this.ctx.drawImage(this.video, this.leftEyeRect.x - ENLARGE, this.leftEyeRect.y - ENLARGE, this.leftEyeRect.width + ENLARGE * 2, this.leftEyeRect.height + ENLARGE * 2, 60, 0, 200, 200);
			this.ctx.drawImage(this.video, this.rightEyeRect.x - ENLARGE, this.rightEyeRect.y - ENLARGE, this.rightEyeRect.width + ENLARGE * 2, this.rightEyeRect.height + ENLARGE * 2, 360, 0, 200, 200);
			
			this.ctx.globalCompositeOperation = 'multiply';
			this.ctx.fillStyle = 'red';
			this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

			this.ctx.globalCompositeOperation = 'destination-out';

			this.ctx.drawImage(this.mask, 0, 0, this.canvas.width, this.canvas.height);
			// this.ctx.fillStyle = "#f30";
			// this.ctx.beginPath();
			// this.ctx.arc(75,75,35,0,Math.PI*2,true);
			// this.ctx.fill();

			// this.ctx.fillRect(this.leftEyeRect.x, this.leftEyeRect.y, this.leftEyeRect.width, this.leftEyeRect.height);
			// for (var i = MOUTH_INDICES.length - 1; i >= 0; i--) {
			// 	// positions[MOUTH_INDICES[i]][0] += 10;
			// }
			// for (i = pModel.path.vertices.length - 1; i >= 0; i--) {
			// 	this.drawTriangle(pModel.path.vertices[i], positions);
			// }
			// for (i = MOUTH_INSIDE_VERTICES_INDICES.length - 1; i >= 0; i--) {
			// 	this.drawTriangle(MOUTH_INSIDE_VERTICES_INDICES[i], positions);
			// }
			// console.log(this.ctracker.getCurrentPosition());
			// this.ctracker.draw(this.canvas);
		};

		App.prototype.drawTriangle = function(indices, positions) {
			this.ctx.save();
			this.ctx.beginPath();
			// this.ctx.fillStyle = 'red';
			this.ctx.moveTo(positions[indices[0]][0], positions[indices[0]][1]);
			this.ctx.lineTo(positions[indices[1]][0], positions[indices[1]][1]);
			this.ctx.lineTo(positions[indices[2]][0], positions[indices[2]][1]);
			this.ctx.closePath();
			// this.ctx.fill();
			this.ctx.stroke();
			this.ctx.clip();
			this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
			this.ctx.restore();
		};

		navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

		var app = new App();
	})();

	</script>
</body>
</html>